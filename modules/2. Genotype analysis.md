#Generating the G and I matrices#

*Setting up parameters*
```{r}
rm(list=ls())
setwd("/Users/fenciso/Desktop/Thesis/GWAS_GS/r")
fileIn<-'genos.RData'
scaleCol<-TRUE
centerCol<-TRUE
minMAF<-.03
maxFreqNA.MRK<-.2
maxFreqNA.Genos<-0.15
outFile="X" # change here X or Z

```
*Basic quality control filtring: removing markers based on MAF and % of NAs*

a. Loading and filtering files
```{r}
load(fileIn)
genoFile<-X # change here X or Z

tmp<-which(MAP$maf<minMAF | MAP$freqNA>maxFreqNA.MRK)
 if(length(tmp)>0){
 genoFile<-genoFile[,-tmp]
 }
```
 b. Removing genotypes with too many NAs
```{r}
 tmp<-which(rowMeans(is.na(genoFile))>maxFreqNA.Genos)
 if(length(tmp)>0){ genoFile<-genoFile[-tmp,] }
```
 c. Naive imputation
```{r}
 for(i in 1:ncol(genoFile)){
 tmp<-mean(genoFile[,i],na.rm=T)
 genoFile[,i]<-ifelse(is.na(genoFile[,i]),tmp,genoFile[,i])
 }
```
 d. Generating the G matrix
```{r}
W<-scale(genoFile,scale=scaleCol,center=centerCol)
G<-tcrossprod(W)/ncol(W)

```
 e. Generating the identity matrix
```{r}
idMat=cov2cor(G)
plot(rowSums(idMat>.9)-1, main="Correlation among potato lines", ylab="% of correlation", xlab="Lines")
text((rowSums(idMat>.9)-1), labels=rownames(idMat), cex= 0.5)
```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/Correlation_plot.png)

 e. Saving files
```{r}
 X_filter=genoFile
 save(X_filter,G,file=paste0(outFile,'_G_TETRA.RData'))
```

#Principal Component Analysis#

```{r}
 EVD<-eigen(G)
 plot(c(0,cumsum(EVD$values)/sum(EVD$values)),type='o',cex=.5,col=4,main="Cumulative % of variance per component", ylab='% of variance', xlab="Number of components")
```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/Cumulative_var.png)

a. Looking the population distribution using the firts four components 
```{r}
pcPer=100*EVD$values[1:4]/sum(EVD$values)
lbls=paste("PC", 1:4, "\n", format(pcPer[1:4], digits=2, cex=0.1), "%", sep="")
pairs(EVD$vectors[,1:4],labels=lbls, cex.labels=1, cex=0.8)
```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/Pairs_PCA.png)

b. Graphic the components that best fit our data
```{r}
plot(EVD$vectors[,2], EVD$vectors[,3], main="Principal Component Analysis", xlab="PC2", ylab="PC3")
text(EVD$vectors[,2], EVD$vectors[,3], labels=rownames(G), cex= 0.3)
```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/PCA.png)

c. Adding colors to the PCA using the tetrapoid additive model
```{r}

## Creating an empty matrix in which each line will be assigned one color
nPCA<-matrix(nrow=nrow(G),ncol=2,NA)
nPCA[,1]=row.names(G)

## Assigning a color for each group

#Group 1
tmp=  which (nPCA[,1]%in%c('stub-234', 'stub-73','stub-178','stub-74', 'stub-220','stub-160', 'stub-222','stub-68' ))
nPCA[tmp,2]="red"

#Group 2
tmp=  which (nPCA[,1]%in%c('stub-647', 'stub-494','stub-496','stub-489','stub-488', 'stub-484','stub-486','stub-492','stub-485', 'stub-493','stub-487','stub-495','stub-670', 'stub-166','stub-491','stub-490' ))
nPCA[tmp,2]="blue"

#Group 3
tmp=which(is.na(nPCA[,2]))
nPCA[tmp,2]="black"

##Generating the pairs plot
pc.percent <- 100 * cumsum(EVD$values)/sum(EVD$values)
lbls= paste("PC", 1:4, "\n", format(pc.percent[1:4], digits=2), "%", sep="")
pairs(EVD$vectors[,1:4], col=nPCA[,2], labels=lbls, cex.labels=2, cex=0.8) 

##Generating the PCA plot
 plot(EVD$vectors[,2], EVD$vectors[,1], main="Principal Component Analysis", xlab="PC2", ylab="PC1", col=nPCA[,2], pch=19)
```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/pairs_color.png)
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/PCA_color.png)

d. Adding colors to the PCA using the diploid additive model

```{r}

## Creating an empty matrix in which each line will be assigned one color
nPCA<-matrix(nrow=nrow(G),ncol=2,NA)
nPCA[,1]=row.names(G)

## Assigning a color for each group

#Group 1
tmp=  which (nPCA[,1]%in%c('stub-234', 'stub-73','stub-178','stub-74', 'stub-220','stub-68' ))
nPCA[tmp,2]="red"

#Group 2
tmp=  which (nPCA[,1]%in%c('stub-647', 'stub-494','stub-496', 'stub-484','stub-486','stub-492','stub-485','stub-487','stub-495','stub-489', 'stub-166','stub-491','stub-490', 'stub-493','stub-488' ))
nPCA[tmp,2]="blue"

#Group 3
tmp=which(is.na(nPCA[,2]))
nPCA[tmp,2]="black"

##Generating the pairs plot
pc.percent <- 100 * cumsum(EVD$values)/sum(EVD$values)
lbls= paste("PC", 1:4, "\n", format(pc.percent[1:4], digits=2), "%", sep="")
pairs(EVD$vectors[,1:4], col=nPCA[,2], labels=lbls, cex.labels=2, cex=0.8) 

##Generating the PCA plot
plot(EVD$vectors[,2], EVD$vectors[,1], main="Principal Component Analysis", xlab="PC2", ylab="PC1", col=nPCA[,2], pch=19)
```
 
 
 
 
## Generating tree for the tetraploid and diploid method
```{r}
library(ape)
tree=dist(X,method="euclidean")
fit <- hclust(d, method="ward.D2")
plot(as.phylo(fit), cex=0.05)

tree=dist(Z,method="euclidean")
fit <- hclust(d, method="ward.D2")
plot(as.phylo(fit), cex=0.05)
```


[Back](https://github.com/fenciso13/Potato_MSU/)
