#Pre-treatments of phenotypes to perform a best linear unbiased prediction (BLUP) analysis#

*Calling libraries*

```{r}
  library(lme4)
```

*Setting up parameters*

```{r}
  rm(list=ls())
  setwd("/Users/fenciso/Desktop/Thesis/GWAS_GS/r")
  phenoFile<-"/Users/fenciso/Desktop/Thesis/GWAS_GS/r/New_phenotype/new_scab_pheno.txt"
  hasHeader=T
  na.strings='NA'
  traitName<-'SCAB'
  logTransform=FALSE
  quant_var=FALSE
```

* Loading and processing*

```{r}
  Y<-read.table(file=phenoFile,header=hasHeader,na.strings=na.strings,stringsAsFactors=F)

  ## Analysis by trait
  DATA=Y[!is.na(Y[,traitName]),]
  DATA$y=DATA[,traitName]
  DATA$y=scale(DATA$y, center=T,scale=T)
  DATA$YEAR_LINE<-paste( DATA$YEAR, DATA$LINE,sep='_')
```

*Getting descriptive statistics*

```{r} 
if(logTransform){ DATA$y=log(DATA$y+1+min(DATA$y)) }
print(paste('Trait=',traitName,' Number of Records=',nrow(DATA)))
```

```
output:
[1] "Trait= SCAB  Number of Records= 3879"
```
a. Trait summary
```{r}
print(table(DATA$YEAR))
```
```
output:
2009 2010 2011 2012 2013 2014 
 632  678  721  687  578  583
``` 

```{r}
print(table(DATA$REP))
```
```
output:
  1   2   3   4 
981 973 972 953 
```
b. Graphics
```{r}
  if(quant_var){
  pdf(paste0(traitName,'_descriptive.pdf'))
  hist(DATA$y)
  boxplot(DATA$yc~DATA$YEAR,main=traitName)
  boxplot(DATA$yc~DATA$LINE,main=traitName)
  boxplot(DATA$yc~DATA$REP,main=traitName)
  dev.off()
  } else {
  pdf(paste0(traitName,'_descriptive.pdf'), height = 7)
  mosaicplot(table(DATA$YEAR,DATA$SCAB), data=DATA, las=1, main="Scab data (Scale~Year)",xlab="Year", ylab="Scale",col=terrain.colors(length(table(DATA$SCAB))))
  dev.off()
 }
 ```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/Scab_plot.png)

*Generating BLUPS and saving the files*

>Formula:
> <img src="https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/ecuation.jpg" width="259" height="21.5" />


```{r}
   
   myFormula<-formula(paste0("y~factor(YEAR)+(1|LINE)+(1|YEAR_LINE)"))
   fm<-lmer(myFormula,data=DATA)  
   print(summary(fm)) # Summary of the blups in which you can find the variance information
   TMP<-ranef(fm)$LINE
   blups<-TMP[,1]
   names(blups)<-rownames(TMP)
   save(blups,file=paste0(traitName,'_blups.RData'))
```
[Back](https://github.com/fenciso13/Potato_MSU/)
