#Pre-treatments of phenotypes to perform a best linear unbiased prediction (BLUP) analysis#

*Calling libraries*

```{r}
  library(lme4)
```

*Setting up parameters*

```{r}
  rm(list=ls())
  setwd("/Users/fenciso/Desktop/Thesis/GWAS_GS/r")
  phenoFile<-"/Users/fenciso/Desktop/Thesis/GWAS_GS/r/New_phenotype/new_scab_pheno.txt"
  hasHeader=T
  na.strings='NA'
  traitName<-'SCAB'
  logTransform=FALSE
  quant_var=FALSE
```

* Loading and processing*

```{r}
  Y<-read.table(file=phenoFile,header=hasHeader,na.strings=na.strings,stringsAsFactors=F)

  ## Analysis by trait
DATA=Y[!is.na(Y[,traitName]),]
DATA$y=DATA[,traitName]
DATA$y=scale(DATA$y, center=T,scale=T) # Make sure that you don't have any NA or character in you data file, otherwise it's going to generate an error.
DATA$YEAR_LINE<-paste( DATA$YEAR, DATA$LINE,sep='_') 

if(logTransform){ DATA$y=log(DATA$y+1-min(DATA$y)) } # check

```

*Getting descriptive statistics*

```{r} 
if(logTransform){ DATA$y=log(DATA$y+1+min(DATA$y)) }
print(paste('Trait=',traitName,' Number of Records=',nrow(DATA)))
```
>output:

>[1] "Trait= SCAB  Number of Records= 3879"

a. Trait summary
```{r}
print(table(DATA$YEAR))
```
>output:

>| 2009 | 2010 | 2011 | 2012 | 2013 | 2014 |
>| ---- |:----:|:----:|:----:|:----:|-----:|
>| 632  | 678  | 721  | 687  | 578  | 583  |

```{r}
print(table(DATA$REP))
```
>output:

>|  1  |  2  |  3  |  4  |
>| --- |:---:|:---:|----:|
>| 981 | 973 | 972 | 953 |

b. Graphics

```{r}
  if(quant_var){
  pdf(paste0(traitName,'_descriptive.pdf'))
  hist(DATA$y)
  boxplot(DATA$yc~DATA$YEAR,main=traitName)
  boxplot(DATA$yc~DATA$LINE,main=traitName)
  boxplot(DATA$yc~DATA$REP,main=traitName)
  dev.off()
  } else {
  pdf(paste0(traitName,'_descriptive.pdf'), height = 7)
  mosaicplot(table(DATA$YEAR,DATA$SCAB), data=DATA, las=1, main="Scab data (Scale~Year)",xlab="Year", ylab="Scale",col=terrain.colors(length(table(DATA$SCAB))))
  dev.off()
 }
 ```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/Scab_plot.png)

*Generating BLUPS and saving the files*

>Formula:

> <img src="https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/ecuation.jpg" width="259" height="21.5" />

```{r}
  myFormula<-formula(paste0("y~factor(YEAR)+(1|LINE)+(1|YEAR_LINE)"))
  fm<-lmer(myFormula,data=DATA)  
  print(summary(fm)) # Summary of the blups in which you can find the variance information
```
>output:

>| Groups        | Name          |  Variance |  Std_Dev |
>| ------------- |:-------------:|:---------:|---------:|
>| YEAR_LINE     | (Intercept)   |   0.03565 |   0.1888 |
>| LINE          | (Intercept)   |   0.43194 |   0.6572 |
>| Residual      |               |   0.50319 |   0.7094 |

```{r}
  TMP<-ranef(fm)$LINE
  blups<-TMP[,1]
  names(blups)<-rownames(TMP)
  save(blups,file=paste0(traitName,'_blups.RData'))
 ``` 
*Comparing LM4 with BGLR*
```{r}
rm(list=ls())
setwd("/Users/fenciso/Desktop/Thesis/GWAS_GS/r")
phenoFile<-"/Users/fenciso/Desktop/Thesis/GWAS_GS/r/New_phenotype/new_scab_pheno.txt"
hasHeader=T
na.strings='NA'
traitName='SCAB'
###

Y<-read.table(file=phenoFile,header=hasHeader,na.strings=na.strings,stringsAsFactors=F)
library(lme4)
library(BGLR)

## Precorrections

DATA=Y[!is.na(Y[,traitName]),]
DATA$y=DATA[,traitName]
DATA$y=scale(DATA$y, center=T,scale=T)
DATA$YEAR_LINE<-paste( DATA$YEAR, DATA$LINE,sep='_')

# Using lm4

fmLM4<-lmer(y~factor(YEAR)+(1|LINE)+(1|YEAR_LINE),data=DATA) 
print(summary(fmLM4))

# Using BGLR

ETA=list(  year=list(~factor(YEAR),data=DATA, model='FIXED'),
           line=list(~factor(LINE)-1,data=DATA, model='BRR'),
           yearXline=list(~factor(YEAR_LINE)-1,data=DATA, model='BRR') 
           )

fmBGLR_lin=BGLR(y=DATA$y,ETA=ETA,nIter=32000,burnIn=2000,thin=10, saveAt='lin_')
fmBGLR_ord=BGLR(y=DATA$y,ETA=ETA,nIter=32000,burnIn=2000,thin=10, response_type='ordinal',saveAt="ord_")

#variance components for BGLR

fmBGLR$varE ## error variance 
fmBGLR$ETA$line$varB
fmBGLR$ETA$yearXline$varB

# Trace plots

plot(scan('ETA_line_varB.dat'),type='o',cex=.5,col=4)
plot(scan('ETA_yearXline_varB.dat'),type='o',cex=.5,col=4)


plot(density(scan('ETA_line_varB.dat')),col=4) ; abline(v=fmBGLR$ETA$line$varB,lty=2,col=2 )

plot(predict(fmLM4),fmBGLR_lin$yHat,cex=.5,col=4)
plot(predict(fmLM4),fmBGLR_ord$yHat,cex=.5,col=4)
```
>lm vs BGLR_linear

![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/fml_linear.png)
>lm vs BGLR_ordinal

![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/flm_ord.png)
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/variance_models.png =100x20)
```{r}
y=DATA$y
tmp=(quantile(y,probs = c(0.15,0.3,0.6,0.85)))
z=ifelse(y<=tmp[1],1, ifelse(y<=tmp[2],2, ifelse(y<=tmp[3],3, ifelse(y<=tmp[4],4,5))))
plot(y~z)
```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/q_plot1.png)
```{r}
tmp=(quantile(y,probs = c(0.2,0.4,0.6,0.8)))
z=ifelse(y<=tmp[1],1, ifelse(y<=tmp[2],2, ifelse(y<=tmp[3],3, ifelse(y<=tmp[4],4,5))))
plot(y~z)
```
![ScreenShot](https://github.com/fenciso13/GWAS_and_GS/blob/master/pdf/q_plot2.png)

[Next_module](https://github.com/fenciso13/GWAS_and_GS/blob/master/modules/4.%20Merging%20Geno%26Pheno%20files.md)

[Back](https://github.com/fenciso13/GWAS_and_GS)
