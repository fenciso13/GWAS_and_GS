#Generating the G-matrix and Principal Component Analisis#

*Setting up parameters*
```{r}
rm(list=ls())
setwd("/Users/fenciso/Desktop/Thesis/GWAS_GS/r")
fileIn<-'genos.RData'
scaleCol<-TRUE
centerCol<-TRUE
minMAF<-.03
maxFreqNA.MRK<-.2
maxFreqNA.Genos<-0.15
#outFile<-"X"# change here X or Z
```
*Basic quality control filtring: removing markers based on MAF and % of NAs*

```{r}
load(fileIn)
genoFile<-X
# 
 
tmp<-which(MAP$maf<minMAF | MAP$freqNA>maxFreqNA.MRK)
 if(length(tmp)>0){
    genoFile<-genoFile[,-tmp]
 }

# Removing genotypes with too many NAs
 tmp<-which(rowMeans(is.na(genoFile))>maxFreqNA.Genos)
 if(length(tmp)>0){ genoFile<-genoFile[-tmp,] }

 # Naive imputation
 for(i in 1:ncol(genoFile)){
    tmp<-mean(genoFile[,i],na.rm=T)
    genoFile[,i]<-ifelse(is.na(genoFile[,i]),tmp,genoFile[,i])
 }

## Generating the variance-covariance matrix (G)

X_filter=genoFile
W<-scale(genoFile,scale=scaleCol,center=centerCol)
G<-tcrossprod(W)/ncol(W)

## Generating an identity matrix

idMat=cov2cor(G)
plot(rowSums(COR>.9)-1)
text((rowSums(COR>.9)-1), labels=rownames(idMat), cex= 0.5)

rownames(idMat)

 save(X_filter,G,file='/Users/fenciso/Desktop/Thesis/GWAS_GS/r/G_TETRA.RData')
 #save(X_filter,G,file=paste0(outFile,'_G_TETRA.RData'))
 #save(X,file=paste0(outFile,'_X.RData')

 EVD<-eigen(G)
 plot(c(0,cumsum(EVD$values)/sum(EVD$values)),type='o',cex=.5,col=4,ylab='% of variance')

 plot(EVD$vectors[,2], EVD$vectors[,3], main="Principal Component Analysis", xlab="PC2", ylab="PC3", pch=".")
 #plot(EVD$vectors[,2], EVD$vectors[,1], main="Principal Component Analysis", xlab="PC2", ylab="PC1",pch=".")
text(EVD$vectors[,2], EVD$vectors[,3], labels=rownames(G), cex= 0.1)
pairs(EVD$vectors[,1:4]) 


## Adding colors to the PCA

nPCA<-matrix(nrow=nrow(G),ncol=2,NA)
nPCA[,1]=row.names(G)

tmp=  which (nPCA[,1]%in%c('stub-234', 'stub-73','stub-178','stub-74', 'stub-220','stub-160', 'stub-222','stub-68' ))
nPCA[tmp,2]="red"

tmp=  which (nPCA[,1]%in%c('stub-647', 'stub-494','stub-496','stub-489','stub-488', 'stub-484','stub-486','stub-492','stub-485', 'stub-493','stub-487','stub-495','stub-670', 'stub-166','stub-491','stub-490' ))

nPCA[tmp,2]="blue"

tmp=which(is.na(nPCA[,2]))
nPCA[tmp,2]="black"

 plot(EVD$vectors[,2], EVD$vectors[,3], main="Principal Component Analysis", xlab="PC2", ylab="PC3", col=nPCA[,2], pch=19)

pc.percent <- 100 * cumsum(EVD$values)/sum(EVD$values)
lbls= paste("PC", 1:4, "\n", format(pc.percent[1:4], digits=2), "%", sep="")
pairs(EVD$vectors[,1:4], col=nPCA[,2], labels=lbls) 
pc.percent

## Ading colors to the PCA using the diploid model

nPCA<-matrix(nrow=nrow(G),ncol=2,NA)
nPCA[,1]=row.names(G)

tmp=  which (nPCA[,1]%in%c('stub-234', 'stub-73','stub-178','stub-74', 'stub-220','stub-68' ))
nPCA[tmp,2]="red"

tmp=  which (nPCA[,1]%in%c('stub-647', 'stub-494','stub-496', 'stub-484','stub-486','stub-492','stub-485','stub-487','stub-495','stub-489', 'stub-166','stub-491','stub-490', 'stub-493','stub-488' ))

nPCA[tmp,2]="blue"

tmp=which(is.na(nPCA[,2]))
nPCA[tmp,2]="black"

 plot(EVD$vectors[,2], EVD$vectors[,3], main="Principal Component Analysis", xlab="PC2", ylab="PC3", col=nPCA[,2], pch=19)

pc.percent <- 100 * cumsum(EVD$values)/sum(EVD$values)
lbls= paste("PC", 1:4, "\n", format(pc.percent[1:4], digits=2), "%", sep="")
pairs(EVD$vectors[,1:4], col=nPCA[,2], labels=lbls) 

## Generating tree for the tetraploid and diploid method

library(ape)
tree=dist(X,method="euclidean")
fit <- hclust(d, method="ward.D2")
plot(as.phylo(fit), cex=0.05)

tree=dist(Z,method="euclidean")
fit <- hclust(d, method="ward.D2")
plot(as.phylo(fit), cex=0.05)
```
